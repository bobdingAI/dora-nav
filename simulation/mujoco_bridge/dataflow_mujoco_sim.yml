# Mujoco Simulation Dataflow with NDT Localization
# This dataflow replaces physical sensors with simulated equivalents
#
# Usage:
#   dora up
#   dora start simulation/mujoco_bridge/dataflow_mujoco_sim.yml

nodes:
  # Mujoco simulation bridge - replaces physical sensor drivers
  - id: mujoco_sim
    custom:
      source: Local
      path: /home/demo/Public/dora-nav/simulation/mujoco_bridge/build/mujoco_sim_bridge
      inputs:
        tick: dora/timer/millis/10
        SteeringCmd: latcontrol/SteeringCmd
        TrqBreCmd: lon_control/TrqBreCmd
      outputs:
        - pointcloud
        - imu_msg
        - ground_truth_pose
    env:
      MUJOCO_MODEL_PATH: /home/demo/Public/dora-nav/simulation/mujoco_bridge/models/robot_warehouse.xml
      SIM_TIMESTEP: "0.001"
      REAL_TIME_FACTOR: "1.0"
      LIDAR_RAYS: "1080"
      LIDAR_VERTICAL_BEAMS: "16"
      LIDAR_RANGE: "100.0"
      LIDAR_MIN_RANGE: "0.5"
      POINTCLOUD_RATE: "10"
      IMU_RATE: "20"
      IMU_ADD_NOISE: "1"

  # NDT Localization node - uses HDL localization with NDT matching
  - id: hdl_localization
    custom:
      source: Local
      path: /home/demo/Public/dora-nav/localization/dora-hdl_localization/build/hdl_localization
      inputs:
        pointcloud: mujoco_sim/pointcloud
        imu_msg: mujoco_sim/imu_msg
      outputs:
        - cur_pose
    env:
      use_imu: "1"
      MAP_PCD: /home/demo/Public/dora-nav/localization/dora-hdl_localization/data/map/indoor.pcd
      way_points: /home/demo/Public/dora-nav/data/path/trajectory.txt

  # Road publisher
  - id: pub_road
    custom:
      source: Local
      path: /home/demo/Public/dora-nav/map/pub_road/build/pubroad
      inputs:
        tick: dora/timer/millis/200
      outputs:
        - road_lane

  # Road lane publisher
  - id: road_lane_publisher_node
    custom:
      source: Local
      path: /home/demo/Public/dora-nav/map/road_line_publisher/build/road_lane_publisher_node
      inputs:
        road_lane: pub_road/road_lane
        cur_pose: hdl_localization/cur_pose
      outputs:
        - cur_pose_all

  # Task publisher
  - id: task_pub_node
    custom:
      source: Local
      path: /home/demo/Public/dora-nav/planning/mission_planning/task_pub/build/task_pub_node
      inputs:
        tick: dora/timer/millis/20
      outputs:
        - road_attri_msg

  # Planning
  - id: planning
    custom:
      source: Local
      path: /home/demo/Public/dora-nav/planning/routing_planning/build/routing_planning_node
      inputs:
        road_lane: pub_road/road_lane
        cur_pose_all: road_lane_publisher_node/cur_pose_all
        road_attri_msg: task_pub_node/road_attri_msg
      outputs:
        - raw_path
        - Request

  # Longitudinal control
  - id: lon_control
    custom:
      source: Local
      path: /home/demo/Public/dora-nav/control/vehicle_control/lon_controller/build/lon_controller_node
      inputs:
        Request: planning/Request
      outputs:
        - TrqBreCmd

  # Lateral control
  - id: latcontrol
    custom:
      source: Local
      path: /home/demo/Public/dora-nav/control/vehicle_control/lat_controller/build/lat_controller_node
      inputs:
        raw_path: planning/raw_path
      outputs:
        - SteeringCmd

  # Visualization with Rerun
  - id: rerun
    custom:
      source: Local
      path: /home/demo/Public/dora-nav/rerun/build/to_rerun
      inputs:
        pointcloud: mujoco_sim/pointcloud
        raw_path: planning/raw_path
        cur_pose: hdl_localization/cur_pose
